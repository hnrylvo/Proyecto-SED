<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Gestión de Médicos</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100">
    <div class="container mx-auto p-6">
      <h2 class="text-3xl font-bold text-center mb-6">
        Gestión de Médicos Veterinarios
      </h2>
      <!-- Verificar si el token existe en el localStorage -->
      <script>
        // Verificar si hay un token de autenticación
        const token = localStorage.getItem("authToken");
        const role = localStorage.getItem("role");

        if (!token || role !== "admin") {
          // Redirigir al inicio si no es administrador
          window.location.href = "../index.html";
        }
      </script>

      <div class="flex justify-end gap-4 mb-4">
        <a
          href="./addDoc.html"
          class="bg-green-500 text-white px-6 py-2 rounded-lg shadow-md hover:bg-green-600 transition duration-300"
        >
          + Agregar Nuevo Médico
        </a>
        <button
          id="logoutBtn"
          class="bg-red-500 text-white px-6 py-2 rounded-lg shadow-md hover:bg-red-600 transition duration-300"
        >
          Cerrar Sesión
        </button>
      </div>

      <div
        id="medicosTable"
        class="bg-white rounded-lg shadow-md overflow-hidden"
      >
        <table class="w-full">
          <thead class="bg-gray-200">
            <tr>
              <th class="p-4 text-left">Nombre</th>
              <th class="p-4 text-left">Especialidad</th>
              <th class="p-4 text-left">Email</th>
              <th class="p-4 text-left">Teléfono</th>
              <th class="p-4 text-center">Acciones</th>
            </tr>
          </thead>
          <tbody id="medicosListBody">
            <!-- Médicos se cargarán dinámicamente aquí -->
          </tbody>
        </table>
      </div>
    </div>

    <script>
      async function cargarMedicos() {
        const medicosListBody = document.getElementById("medicosListBody");
        const token = localStorage.getItem("authToken");

        try {
          const response = await fetch("http://localhost:3000/admin/doctors", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error("Error al cargar médicos");
          }

          const medicos = await response.json();
          medicosListBody.innerHTML = "";

          medicos.forEach((medico) => {
            const medicoRow = document.createElement("tr");
            medicoRow.className = "border-b";
            medicoRow.innerHTML = `
                <td class="p-4">${medico.nombre}</td>
                <td class="p-4">${medico.especialidad}</td>
                <td class="p-4">${medico.email}</td>
                <td class="p-4">${medico.telefono}</td>
                <td class="p-4 text-center">

                    <button onclick="eliminarMedico('${medico._id}')" class="text-red-500 hover:text-red-700">
                        Eliminar
                    </button>
                </td>
            `;
            medicosListBody.appendChild(medicoRow);
          });

          if (medicos.length === 0) {
            medicosListBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center p-4 text-gray-500">
                        No se han registrado médicos
                    </td>
                </tr>
            `;
          }
        } catch (error) {
          console.error("Error al cargar médicos:", error);
          medicosListBody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center p-4 text-red-500">
                    Error al cargar los médicos. Intente nuevamente.
                </td>
            </tr>
        `;
        }
      }

      async function eliminarMedico(id) {
        if (confirm("¿Está seguro que desea eliminar este médico?")) {
          try {
            const token = localStorage.getItem("authToken");
            console.log("Intentando eliminar médico con ID:", id); // Debug

            const response = await fetch(
              `http://localhost:3000/admin/doctors/${id}`,
              {
                method: "DELETE",
                headers: {
                  Authorization: `Bearer ${token}`,
                  "Content-Type": "application/json",
                },
                credentials: "include",
              }
            );

            console.log("Respuesta del servidor:", response.status); // Debug

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || "Error al eliminar médico");
            }

            const data = await response.json();
            console.log("Respuesta exitosa:", data); // Debug

            alert("Médico eliminado exitosamente");
            await cargarMedicos(); // Recargar la lista
          } catch (error) {
            console.error("Error detallado:", error);
            alert(error.message || "Error al procesar la solicitud");
          }
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("authToken");
        if (!token) {
          window.location.href = "../index.html";
          return;
        }
        cargarMedicos();
      });
    </script>

    <!-- Cerrar sesión -->
    <script>
      document.getElementById("logoutBtn").addEventListener("click", () => {
        try {
          localStorage.removeItem("authToken");
          localStorage.removeItem("role");

          document.cookie.split(";").forEach(function (c) {
            document.cookie = c
              .replace(/^ +/, "")
              .replace(
                /=.*/,
                "=;expires=" + new Date().toUTCString() + ";path=/"
              );
          });

          window.location.href = "../index.html";
        } catch (error) {
          console.error("Error al cerrar sesión:", error);
        }
      });
    </script>
  </body>
</html>
