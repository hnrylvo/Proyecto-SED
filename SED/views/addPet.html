<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Veterinaria - Nueva Mascota</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-xl shadow-md w-[500px]">
      <h2 class="text-2xl font-bold text-center mb-6">
        Registrar Nueva Mascota
      </h2>
      <form id="mascotaForm" class="space-y-4" novalidate>
        <div>
          <label for="nombre" class="block text-sm font-medium text-gray-700">
            Nombre de la Mascota
          </label>
          <input
            type="text"
            id="nombre"
            name="nombre"
            required
            minlength="2"
            maxlength="50"
            pattern="^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"
          />
          <span id="nombreError" class="text-red-500 text-sm hidden"></span>
        </div>

        <div>
          <label for="especie" class="block text-sm font-medium text-gray-700">
            Especie
          </label>
          <select
            id="especie"
            name="especie"
            required
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"
          >
            <option value="">Seleccionar Especie</option>
            <option value="perro">Perro</option>
            <option value="gato">Gato</option>
            <option value="ave">Ave</option>
            <option value="otro">Otro</option>
          </select>
          <span id="especieError" class="text-red-500 text-sm hidden"></span>
        </div>

        <div>
          <label for="raza" class="block text-sm font-medium text-gray-700">
            Raza
          </label>
          <input
            type="text"
            id="raza"
            name="raza"
            required
            minlength="2"
            maxlength="50"
            pattern="^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"
          />
          <span id="razaError" class="text-red-500 text-sm hidden"></span>
        </div>

        <div>
          <label for="edad" class="block text-sm font-medium text-gray-700">
            Edad (años)
          </label>
          <input
            type="number"
            id="edad"
            name="edad"
            min="0"
            max="30"
            required
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"
          />
          <span id="edadError" class="text-red-500 text-sm hidden"></span>
        </div>

        <div>
          <label for="peso" class="block text-sm font-medium text-gray-700">
            Peso (kg)
          </label>
          <input
            type="number"
            id="peso"
            name="peso"
            step="0.1"
            min="0"
            max="500"
            required
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"
          />
          <span id="pesoError" class="text-red-500 text-sm hidden"></span>
        </div>

        <div>
          <label
            for="observaciones"
            class="block text-sm font-medium text-gray-700"
          >
            Observaciones Médicas
          </label>
          <textarea
            id="observaciones"
            name="observaciones"
            rows="3"
            maxlength="500"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm resize-none"
          ></textarea>
        </div>

        <button
          type="submit"
          class="w-full bg-green-500 text-white py-2 rounded-md hover:bg-green-600 transition duration-300"
        >
          Registrar Mascota
        </button>
      </form>
      <a
        href="../views/home.html"
        class="block text-center mt-4 text-blue-500 hover:underline"
        >Volver al Inicio</a
      >
    </div>

    <script>
      // Sanitize input to prevent XSS
      function sanitizeInput(input) {
        const div = document.createElement("div");
        div.textContent = input;
        return div.innerHTML;
      }

      // Advanced input validation function
      function validateInput(input, type) {
        switch (type) {
          case "nombre":
          case "raza":
            return /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]{2,50}$/.test(input);
          case "edad":
            return !isNaN(input) && input >= 0 && input <= 30;
          case "peso":
            return !isNaN(input) && input > 0 && input <= 500;
          case "especie":
            return ["perro", "gato", "ave", "otro"].includes(input);
          default:
            return true;
        }
      }

      document
        .getElementById("mascotaForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          let isValid = true;
          const formElements = ["nombre", "especie", "raza", "edad", "peso"];

          // Reset previous error messages
          formElements.forEach((element) => {
            const errorSpan = document.getElementById(`${element}Error`);
            errorSpan.textContent = "";
            errorSpan.classList.add("hidden");
          });

          // Validate and sanitize inputs
          const mascotaData = {};
          formElements.forEach((element) => {
            const inputElement = document.getElementById(element);
            const value = inputElement.value.trim();

            if (!validateInput(value, element)) {
              const errorSpan = document.getElementById(`${element}Error`);
              errorSpan.textContent = `Por favor, ingrese un ${element} válido`;
              errorSpan.classList.remove("hidden");
              isValid = false;
            } else {
              mascotaData[
                element === "nombre"
                  ? "name"
                  : element === "raza"
                  ? "breed"
                  : element === "especie"
                  ? "species"
                  : element === "edad"
                  ? "age"
                  : "weight"
              ] =
                element === "edad"
                  ? parseInt(value, 10)
                  : element === "peso"
                  ? parseFloat(value)
                  : sanitizeInput(value);
            }
          });

          // Sanitize optional observations
          const observaciones = document
            .getElementById("observaciones")
            .value.trim();
          mascotaData.medicalNotes = sanitizeInput(observaciones);

          if (!isValid) return;

          try {
            // Use more secure token retrieval
            const token = document.cookie
              .split("; ")
              .find((row) => row.startsWith("token="))
              ?.split("=")[1];

            if (!token) {
              alert(
                "No se encontró una sesión válida. Por favor, inicie sesión."
              );
              return;
            }

            const response = await fetch("http://localhost:3000/user/animals", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
                "X-Requested-With": "XMLHttpRequest", // CSRF protection
              },
              credentials: "same-origin", // More secure credentials handling
              body: JSON.stringify(mascotaData),
            });

            const data = await response.json();

            if (response.ok) {
              alert("Mascota registrada exitosamente");
              window.location.href = "../views/home.html";
            } else {
              alert(data.error || "Error al registrar la mascota.");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("Error en el servidor. Intenta nuevamente.");
          }
        });
    </script>
  </body>
</html>
